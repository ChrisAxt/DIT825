from django import template
from app.models import LabeledSentence
from django.http import JsonResponse

from app.utils import sendRequest

register = template.Library()

@register.simple_tag
def getBatchPrediction():
    dataPoints = LabeledSentence.objects.all()[:50]
    sentenceList = [data.sentence for data in dataPoints]
    # evaluationResults = sendRequest(sentenceList)

    # results = {}
    # results = {dataPoints[i].sentence: { 'true_value' : dataPoints[i].label_bias, 'predicted_value' : evaluationResults[i][0]} for i in range(len(sentenceList))}

    results = {'YouTube is making clear there will be no “birtherism” on its platform during this year’s U.S. presidential election – a belated response to a type of conspiracy theory more prevalent in the 2012 race.': {'true_value': 'Biased', 'predicted_value': [3.02493572e-05]}, 'The increasingly bitter dispute between American women’s national soccer team and the U.S. Soccer Federation spilled onto the field Wednesday night when players wore their warm-up jerseys inside outin a protest before their 3-1 victory over Japan.': {'true_value': 'Non-biased', 'predicted_value': [0.999991834]}, 'So while there may be a humanitarian crisis driving more vulnerable people to seek asylum in the United States, there is no security crisis.': {'true_value': 'Biased', 'predicted_value': [0.994115114]}, 'A professor who teaches climate change classes — a subject some would question as a legitimate area of study — said she has seen students who suffer fear, grief, stress, and anxiety about the future.': {'true_value': 'Non-biased', 'predicted_value': [0.999966264]}, 'Looking around the United States, there is never enough welfare for the left to stop killing developing humans in utero—solidly Democratic states lead the nation in abortion rates.': {'true_value': 'Biased', 'predicted_value': [0.000176429749]}, 'The World Anti-Doping Agency on Tuesday said that Russian authorities had failed to provide access to laboratory doping data by their year-end deadline and it will consider sanctions against the Russian Anti-Doping Agency (RUSADA).': {'true_value': 'Non-biased', 'predicted_value': [0.999985456]}, 'The Republican president assumed he was helping the industry at the expense of the environment – a trade-off Trump was happy to make since he rejects climate science anyway.': {'true_value': 'Biased', 'predicted_value': [0.000774353743]}, 'The explosion of the Hispanic population has long-term job prospect consequences as well: Both legal and illegal aliens will occupy 75 percent of new American jobs in as little as five years.': {'true_value': 'Biased', 'predicted_value': [0.999780178]}, 'The anti-vaccine movement made headlines last spring, when widespread distrust of the pharmaceutical industry and the belief that vaccines can lead to autism in children led to a measles outbreak.': {'true_value': 'Biased', 'predicted_value': [0.00159686804]}, "Thousands of fetal remains that were found at an abortion doctor's suburban Chicago garage last year were buried Wednesday at an Indiana cemetery.": {'true_value': 'Non-biased', 'predicted_value': [0.999884963]}, 'Defending Democracy Together, a group of “Never Trump” conservatives including commentator Bill Kristol, created Republican Voters Against Trump. It is among several groups on the right ― including the Lincoln Project, which was co-founded by attorney George Conway and GOP strategists Rick Wilson and Steve Schmidt ― targeting the president as the election approaches.': {'true_value': 'Non-biased', 'predicted_value': [0.99999]}, 'Voting in quasi-militarized settings was not confined to the nation’s capital. In Philadelphia, on election eve, the mayor announced a curfew that was slated to take effect an hour before its polls closed, but subsequently delayed it after an outcry by other city officials and activists.': {'true_value': 'Biased', 'predicted_value': [4.99486923e-05]}, 'But one glaring absentee was Trump, who not only declined an invitation but failed to send any American representative at all.': {'true_value': 'Biased', 'predicted_value': [0.000893414]}, 'Planned Parenthood, the abortion industry giant says the “white supremacy” and “systemic bias in policing” that “took George Floyd’s life” are the same factors involved in “attacks” on women’s abortion rights.': {'true_value': 'Non-biased', 'predicted_value': [0.00972682238]}, 'From the Rio Grande Valley in Texas to the Southern California coast, the Trump administration continues separating migrant families at rates that alarm immigration attorneys and advocates, even though a federal judge barred family separations as a systemic policy.': {'true_value': 'Biased', 'predicted_value': [0.999893]}, 'Track and field athletes don’t typically earn the lucrative salaries seen in the NBA, NFL, tennis or international soccer.': {'true_value': 'Biased', 'predicted_value': [0.988920808]}, 'Cuba’s health ministry initially vowed an investigation into Paloma Dominguez Caballero’s death; last week, state media published a report essentially absolving the government of any wrongdoing, categorically stating that nothing was wrong with the vaccine Dominguez received.': {'true_value': 'Non-biased', 'predicted_value': [0.999969602]}, 'In other words, the agency responsible for protecting consumers now wants to make it easier for them to get stuck in a cycle of debt they can never repay.': {'true_value': 'Biased', 'predicted_value': [8.77380371e-05]}, 'While each sport has its own rules with regards to religious headwear, Muslim women who compete while wearing a hijab have faced a litany of obstacles.': {'true_value': 'Biased', 'predicted_value': [0.00391879678]}, 'Even as U.S. immigration officials have pushed to deport hundreds of Iraqi Christians over the last few years, asserting in court that they are unlikely to be targeted in their homeland, another arm of the Trump administration has insisted just the opposite, saying that Christians in Iraq face terror and extortion.': {'true_value': 'Non-biased', 'predicted_value': [0.999987602]}, 'Although he didn’t seem to direct his comments at anyone in particular, many celebrities that consider themselves climate change activists have not adjusted their lifestyles of taking private jets to their engagements around the globe, for example, Leonardo DiCaprio, Katy Perry and Orlando Bloom all took heat in 2019 when they were among the A-listers to attend Google’s climate change conference by way of private jets and mega yachts.': {'true_value': 'Non-biased', 'predicted_value': [0.999990463]}, 'A Catholic priest in Rhode Island who barred state lawmakers who supported an abortion rights bill from receiving communion at his church has doubled down on his stance, saying abortion is worse than pedophilia.': {'true_value': 'Biased', 'predicted_value': [2.59280205e-05]}, 'Gwyneth Paltrow’s anti-vaxxer ally comes under fire for ‘discredited pseudo-scientific claims’ about coronavirus': {'true_value': 'Biased', 'predicted_value': [0.00281268358]}, 'The taxpayer-funded BBC has announced that 16-year-old eco-warrior Greta Thunberg will be guest-editing the broadcaster’s flagship current affairs radio programme, the Today show.': {'true_value': 'Non-biased', 'predicted_value': [0.999834061]}, 'The German Federal State of Baden-Wuerttemberg is seeking damages from Volkswagen after local authorities purchased VW diesel vehicles which now face bans in cities like Stuttgart, Frankfurter Allgemeine Zeitung said on Saturday.': {'true_value': 'Non-biased', 'predicted_value': [0.999982]}, "More than 100 gang members from El Salvador are among the massive wave of migrants that's poured across the border in recent months, with nearly 400 illegal immigrants nabbed trying to cross en masse last week and a group of more than 100 caught scaling a wall Monday, beleaguered border officials said.": {'true_value': 'Biased', 'predicted_value': [3.52561474e-05]}, "Gadsby's work is a testament to how eagerly the arbiters of our culture will devour and elevate work that convincingly purports to be progressive.": {'true_value': 'Biased', 'predicted_value': [8.29100609e-05]}, 'That’s led some vaccine foes to join the protesters — whom Trump has encouraged on Twitter — in staging demonstrations in state capitals to “reopen America.”': {'true_value': 'Biased', 'predicted_value': [0.000598460436]}, 'Mississippi’s Republican governor signed one of America’s strictest abortion bills on Thursday banning women from obtaining an abortion once a fetal heartbeat is detected, which can often occur before a woman even realizes she is pregnant.': {'true_value': 'No agreement', 'predicted_value': [0.958146393]}, 'That’s why white nationalists, who are enthusiasts for the abortion of black and brown people, despise pro-lifers, as anyone reporting in good faith should know.': {'true_value': 'Biased', 'predicted_value': [0.000154107809]}, 'President Donald Trump ridiculed former Secretary of State Colin Powell on Sunday for endorsing former Vice President Joe Biden for president.': {'true_value': 'No agreement', 'predicted_value': [0.475952744]}, 'Biden was particularly critical of Trump’s visit on Monday to a historic church across from the White House, which was preceded by law enforcement authorities dispersing a crowd near the church with smoke canisters and flash grenades.': {'true_value': 'Biased', 'predicted_value': [4.12464142e-05]}, 'The other witnesses at the hearing shared story after story about how Americans are struggling to pay off student loans, with many having to delay getting married, buying a home, and having children.': {'true_value': 'Non-biased', 'predicted_value': [0.816653967]}, 'French sporting goods retailer Decathlon has confirmed they will not be stocking a sports hijab after public backlash and threats of a mass boycott.': {'true_value': 'Non-biased', 'predicted_value': [0.836391032]}, 'Young women taking part in high school and college athletics across the country have had their dreams of winning dashed by the movement to allow biological male who “identify” as female to compete against them.': {'true_value': 'Biased', 'predicted_value': [0.00165778399]}, 'Australian sports stars, sparked in part by a call to action from tennis player Nick Kyrgios, have rallied to raise funds in support of relief and recovery efforts for victims of the country’s bushfire catastrophe.': {'true_value': 'Non-biased', 'predicted_value': [0.126214]}, 'Under current immigration policies, it’s possible that immigration arrests could lead to poor mental health by increasing deportation fears among undocumented individuals and their families and neighbors, the study authors write.': {'true_value': 'Biased', 'predicted_value': [0.00130814314]}, 'Less-organized migrants, tighter immigration control by Guatemalan authorities and the presence of U.S. advisers have reduced the likelihood that the hundreds of migrants who departed Honduras will form anything like the cohesive procession the term “caravan” now conjures.': {'true_value': 'Biased', 'predicted_value': [0.187861145]}, 'U.S. Education Secretary Betsy DeVos is withdrawing protections put in place by former President Barack Obama for students who have mismanaged or are defaulting on their college loans.': {'true_value': 'Non-biased', 'predicted_value': [0.998935819]}, 'Trump enjoys and encourages state brutality against people of color, and black people in particular. It excites him and his most ardent followers. But his response isn’t just based on personal predilections. It’s also based on political considerations.': {'true_value': 'Biased', 'predicted_value': [0.000323981047]}, 'For the first time the annual risk report, compiled by the World Economic Forum (WEF), found the top five concerns were all environmental, from extreme weather to biodiversity loss and events like oil spills and radioactive contamination.': {'true_value': 'Non-biased', 'predicted_value': [0.999986768]}, 'Abortionists, who prey on desperate people, should no longer receive your hard-earned tax dollars.': {'true_value': 'Biased', 'predicted_value': [0.000357538462]}, 'The Trump administration has continued to deny climate change findings and make scientific reports inaccessible to the public.': {'true_value': 'Biased', 'predicted_value': [0.00210344791]}, 'As controversies about the “reopening” of America loom over our lives, nothing seems as intrinsically irrelevant — yet possibly as critically important — as how soon major spectator sports return.': {'true_value': 'Non-biased', 'predicted_value': [0.99997282]}, 'In the months that followed, all independent polling has found the American mainstream not only blames Trump and his party for the shutdown, but also does not want to spend billions of taxpayer dollars on an ineffective and unnecessary border wall.': {'true_value': 'Biased', 'predicted_value': [2.32458115e-05]}, 'Members of the German Green Party have proposed that so-called “climate refugees” should be allowed to move to the country and receive a German passport upon their arrival.': {'true_value': 'Non-biased', 'predicted_value': [0.999602735]}, 'Kendrick, who, like many Planned Parenthood supporters, blames men for pro-life legislation while she ignores mention of the life of unborn babies, also drafted a “testicular bill of rights.': {'true_value': 'Biased', 'predicted_value': [0.00197353959]}, 'Abortion propaganda was always meant to obscure the reality of abortion, not justify it.': {'true_value': 'Biased', 'predicted_value': [0.00114545226]}, 'UFC Middleweight Champion Israel Adesanya’s comment that his opponent will "crumble like the Twin Towers", in addition to being terrible and inappropriate, also makes no sense.': {'true_value': 'Biased', 'predicted_value': [0.000158184281]}, 'Yet when researchers in the U.S. have been so corrupt they have gone to jail, mainstream scientists still accept their research.': {'true_value': 'Biased', 'predicted_value': [0.00137450336]}}

    evaluationResults = getEvaluationResults(results)
    return evaluationResults

@register.simple_tag
def saveEvaluationResults(data):


@register.simple_tag
def getEvaluationResults(results):
    TN = 0
    TP = 0
    FP = 0
    FN = 0
    for result in results.items():
        if (result[1]['true_value'] == 'Biased'): 
            if (result[1]['predicted_value'][0] < 0.5):
                TP += 1
            else: FN += 1
        elif (result[1]['true_value'] == 'Non-biased'):
            if (result[1]['predicted_value'][0] >= 0.5):
                TN += 1
            else: FP += 1
    return {'true_positive':TP, 'true_negative':TN, 'false_positive': FP, 'false_negative': FN}

@register.simple_tag
def getAccuracy(evaluation):
    total = evaluation['true_positive'] + evaluation['false_positive'] + evaluation['true_negative'] + evaluation['false_negative']
    accuracy = (evaluation['true_positive'] + evaluation['true_negative']) / total
    return f"{accuracy * 100:.2f}"

@register.simple_tag
def getPrecision(evaluation):
    precision = evaluation['true_positive'] / (evaluation['false_positive'] + evaluation['true_positive'])
    return f"{precision * 100:.2f}"

@register.simple_tag
def getNegPrecision(evaluation):
    precision = evaluation['true_negative'] / (evaluation['true_negative'] + evaluation['false_negative'])
    return f"{precision * 100:.2f}"

@register.simple_tag
def getRecall(evaluation):
    recall = evaluation['true_positive'] / (evaluation['true_positive'] + evaluation['false_negative'])
    return f"{recall * 100:.2f}"